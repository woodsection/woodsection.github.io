<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Istio 에서의 authentication" /><meta name="author" content="woodsection" /><meta property="og:locale" content="ko" /><meta name="description" content="Authentication (인증)" /><meta property="og:description" content="Authentication (인증)" /><link rel="canonical" href="https://woodsection.github.io/posts/istio-security-authentication/" /><meta property="og:url" content="https://woodsection.github.io/posts/istio-security-authentication/" /><meta property="og:site_name" content="나무계단 블로그" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-26T22:32:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Istio 에서의 authentication" /><meta name="twitter:site" content="@not" /><meta name="twitter:creator" content="@woodsection" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"woodsection"},"dateModified":"2022-07-26T22:32:00+09:00","datePublished":"2022-07-26T22:32:00+09:00","description":"Authentication (인증)","headline":"Istio 에서의 authentication","mainEntityOfPage":{"@type":"WebPage","@id":"https://woodsection.github.io/posts/istio-security-authentication/"},"url":"https://woodsection.github.io/posts/istio-security-authentication/"}</script><title>Istio 에서의 authentication | 나무계단 블로그</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="나무계단 블로그"><meta name="application-name" content="나무계단 블로그"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">나무계단 블로그</a></div><div class="site-subtitle font-italic">배운것을 기록합니다</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/woodsection" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/not" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['woodsection+blog','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Istio 에서의 authentication</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Istio 에서의 authentication</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658842320" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 26, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> woodsection </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2336 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><h1 id="authentication-인증">Authentication (인증)</h1><h1 id="기본-컨셉">기본 컨셉</h1><p>Istio에서는 두 가지 authentication(인증) 방식을 제공합니다.</p><ol><li>Peer authenticaion<ul><li>클라이언트의 연결을 확인하기 위해 서비스간 인증에 사용되는 인증방식입니다.</ul></ol><p>Istio에서는 서비스 코드의 변경없이 활성화가능한 상호간 TLS를 제공합니다.</p><ul><li>서비스간 통신 보호<li>클러스터 - 클라우드 사이에 운용가능한 ID를 각 서비스에 제공<li>키, 인증서를 생성 및 배포, 순환을 자동화하는 시스템 제공<ol><li>Request authentication</ol></ul><p>end 유저를 위한 사용자 인증에 사용됩니다.</p><p>JWT를 이용한 유효성 검사, 권한확인 혹은 OpenID Connect 공급자를 사용해 개발자 환경을 제공합니다.</p><p>예시로</p><ul><li>ORY Hydra, Keycloak, Auth0, Firebase Auth, Google Auth 등 ..</ul><p>Istio는 인증정책은 <code class="language-plaintext highlighter-rouge">Istio config store</code>에 k8s CRD를 이용해 저장하며, istiod는 키를 통해 각각의 프록시를 최신 정보로 업데이트합니다.</p><h1 id="mutual-tls-authentication-상호간-tls-인증"><strong>Mutual TLS authentication (상호간 TLS 인증)</strong></h1><p>Istio에서는 Envoy 프록시로 구현하는 클라이언트와 서버측의 PEP를 이용해 서비스간 통신을 터널링합니다.</p><p>Mutual TLS 인증으로 다른 워크로드에 request 할때의 동작방식은 다음과 같습니다.</p><ol><li>클라이언트의 로컬 사이드카 Envoy로 아웃바운드를 다시 라우팅합니다.<li>클라이언트 Envoy와 서버 Envoy가 TLS handshake를 수행합니다. 핸드쉐이크가 일어나는동안, 클라이언트 Envoy 에서는 secure naming 검사를 통해 서버 인증서의 service account가 대상의 서비스를 실행할 권한이 있는지 확인합니다.<li>각 Envoy는 TLS 연결을 설정하고, 클라이언트의 Envoy는 서버의 Envoy로 트래픽을 전달합니다.<li>서버 Envoy가 요청을 승인하고, 로컬 TCP 연결로 트래픽을 백엔드 서비스로 전달합니다.</ol><h2 id="permissive-mode-허용모드"><span class="mr-2">Permissive mode (허용모드)</span><a href="#permissive-mode-허용모드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>서비스가 일반 트래픽과 Mutual TLS 트래픽을 모두 수락할 수 있는 모드입니다.</p><h2 id="secure-naming"><span class="mr-2">Secure naming</span><a href="#secure-naming" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>server identity는 인증서로 인코딩되지만, 서비스의 이름은 서비스나 DNS를 통해 검색됩니다.</p><p>secure naming은 server indentity를 서비스 이름에 매핑하며, 이는 server identity가 서비스를 실행할 권한이 있음을 의미합니다.</p><p>마스터 노드에서 apiserver를 감시하고 sercure naming을 생성하여 PEP에 배포합니다.</p><p>서비스를 호출할때, 인증서에서 ID를 추출하고, secure naming과 비교하여 봄으로서 서비스 실행가능 여부를 검증하므로, secure naming을 통해 DNS spoofing, BGP/route hijacking, ARP spoofing 등의 공격으로부터 보호할 수 있는 수단이됩니다.</p><h1 id="authentication-architecture-인증-아키텍처"><strong>Authentication architecture (인증 아키텍처)</strong></h1><p>peer와 authorization policy를 사용해서 워크로드에 대한 인증 설정을 지정할 수 있습니다.</p><p>yaml 파일을 통해 policy를 지정하고 정책이 배포되면 istio 구성 스토리지에 저장되며, istio controller에서 구성 스토리지를 감시합니다.</p><p>policy의 변경시 istio는 변경된 policy를 엔드포인트에 비동기식으로 보내고, 프록시가 수신하면 해당 policy가 포드에 즉시 적용됩니다.</p><p>이러한 요청은 다음과 같은 아키텍처를 통해 이뤄집니다.</p><p><img data-src="https://istio.io/latest/docs/concepts/security/authn.svg" alt="https://istio.io/latest/docs/concepts/security/authn.svg" data-proofer-ignore></p><h1 id="authentication-policies-인증정책"><strong>Authentication policies (인증정책)</strong></h1><p>인증정책은 서비스가 수신하는 request에 적용되며, mutural TLS에서 클라이언트 측의 인증 규칙을 지정하기 위해선 <code class="language-plaintext highlighter-rouge">DestinationRule</code> 을 설정해야합니다.</p><p>앞서 이야기했듯이 yaml 파일 형식으로 k8s의 CRD를 통해 지정할 수 있습니다.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">security.istio.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PeerAuthentication</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example-peer-policy"</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foo"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">reviews</span>
  <span class="na">mtls</span><span class="pi">:</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">STRICT</span>
</pre></table></code></div></div><h2 id="policy-storage-정책-저장"><span class="mr-2"><strong>Policy storage (정책 저장)</strong></span><a href="#policy-storage-정책-저장" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>istio root 네임스페이스에 mesh-scope policy를 저장합니다.</p><p>이 정책은 전역적으로 설정되며, 네임스페이스를 지정하여 policy를 저장하면, 해당 네임스페이스 내의 워크로드내에서만 적용이 됩니다.</p><p><code class="language-plaintext highlighter-rouge">selector</code> 필드를 이용하여 네임스페이스를 지정할 수 있습니다.</p><h2 id="selector-field"><span class="mr-2">Selector field</span><a href="#selector-field" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>다음과 같이 selector 필드를 이용해 정책이 적용되는 워크로드 레이블을 지정할 수 있습니다.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="na">selector</span><span class="pi">:</span>
  <span class="na">matchLabels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">product-page</span>
</pre></table></code></div></div><ul><li>selector 필드에 값이 없으면, 루트 네임스페이스에 대해 지정된 정책이 적용됩니다.</ul><p>다음과 같은 순서로 각 워크로드에 정책을 적용합니다.</p><ol><li>워크로드별<li>네임스페이스 전체<li>메쉬 전체</ol><p>정책이 여러가지가 적용되면, 모든 정책을 결합해서 적용되므로 여러 네임스페이스의 정책을 가질수도 있지만 권장하지는 않습니다.</p><h2 id="peer-authentication-피어-인증"><span class="mr-2"><strong>Peer authentication (피어 인증)</strong></span><a href="#peer-authentication-피어-인증" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>피어인증에서는 mutural TSL 모드를 지정하며, 지원되는 모드는 다음과 같습니다.</p><ul><li>PERMISSIVE(허용)<ul><li>Mutural TSL, 일반 트래픽 모두 허용하며, 사이드카가 없는 워크로드에서 사용하기에 적합합니다.<li>사이드카가 적용이 된 후에는 STRICT 모드로 변경해야합니다.</ul><li>STRICT(엄격)<ul><li>Mutural TSL만을 허용합니다.</ul><li>DISABLE(비활성화)<ul><li>Mutural TSL이 비활성화되므로 자체적인 보안 솔루션이 없다면 비활성화모드를 사용해선 안됩니다.</ul></ul><p>모드가 적용되지않으면 상위의 모드가 상속되며, 상속될 모드도 없다면 PERMISSIVE 모드로 적용됩니다.</p><p>다음의 설정에선 <code class="language-plaintext highlighter-rouge">foo</code> 네임스페이스 상의 워크로드에게 STRICT 모드가 적용됩니다.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">security.istio.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PeerAuthentication</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example-policy"</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foo"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">mtls</span><span class="pi">:</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">STRICT</span>
</pre></table></code></div></div><p>특정 포트만을 지정하여 모드를 지정하는 것도 가능합니다.</p><p>다음의 설정에선 <code class="language-plaintext highlighter-rouge">foo</code> 네임스페이스에 속하는 <code class="language-plaintext highlighter-rouge">80</code> 포트의 워크로드에서 Mutural TSL을 비활성화했습니다.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">security.istio.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PeerAuthentication</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example-workload-policy"</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foo"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
     <span class="na">matchLabels</span><span class="pi">:</span>
       <span class="na">app</span><span class="pi">:</span> <span class="s">example-app</span>
  <span class="na">portLevelMtls</span><span class="pi">:</span>
    <span class="na">80</span><span class="pi">:</span>
      <span class="na">mode</span><span class="pi">:</span> <span class="s">DISABLE</span>
</pre></table></code></div></div><p>다음의 구성에선 Mutural TSL이 비활성화된 80 포트로 바인딩되므로 요청이 성공적으로 작동합니다.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">example-service</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">foo</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">example-app</span>
</pre></table></code></div></div><h2 id="request-authentication"><span class="mr-2"><strong>Request authentication</strong></span><a href="#request-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>JWT의 유효성을 검사하기 위해 필요한 값을 지정하며, 그 값은 다음과 같습니다.</p><ul><li>request에서의 token의 위치<li>issuer와 request<li>공개 JSON 웹 키 set(JWKS)</ul><p>istio에서 규칙에 따라 토큰을 확인하고 유효성 여부를 판단합니다.</p><p>request에 token이 없으면, 기본적으로 허용되며, 토큰이 없는 요청을 거부하려면 path, action 등을 지정하는 규칙을 지정해야합니다.</p><p>둘 이상의 정책이 워크로드에 적용되어있다면, 각 정책에 따라 둘 이상의 JWT를 지정할 수 있으며, 단일 정책처럼 모든 규칙을 결합합니다.</p><p>하지만, 둘 이상의 JWT가 있는 요청은 지원하지 않습니다.</p><p>즉, 정책이 2개가 적용된 워크로드에 대하여 각 정책에 적용되는 JWT 1개 씩 총 2개는 가능하지만,</p><p>정책이 2개가 적용된 워크로드에 대하여 각 정책에 적용되는 JWT 2개씩 총 4개는 불가능합니다.</p><h2 id="principals"><span class="mr-2">Principals</span><a href="#principals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>peer authentication policy, mutural TLS 등을 사용할 때, identity를 가져오기 위해 <code class="language-plaintext highlighter-rouge">source.principal</code> , <code class="language-plaintext highlighter-rouge">request.auth.principal</code> 등과 같은 보안 주체를 사용합니다.</p><h1 id="updating-authentication-policies-인증정책-업데이트"><strong>Updating authentication policies (인증정책 업데이트)</strong></h1><p>authentication policy는 언제든 변경될 수 있으며, 거의 실시간으로 적용됩니다.</p><p>하지만, 모든 워크로드가 새로운 정책을 수신했는지 보장할 순 없습니다.</p><p>때문에 istio에서는 다음과 같이 권장합니다.</p><ul><li>모드를 DISABLE → STRICT 또는 그 반대의 경우로 변경하고자한다면, 중간에 PERMISSIVE 모드로 지정한 뒤 바꿔야합니다. Istio telemetry를 통해 모드가 성공적으로 바뀌었는지 확인할 수 있습니다.<li>request authentication을 다른 jwt로 마이그레이션하고자할때, 이전 규칙을 냅둔 상태로 새 jwt 정책을 추가한 뒤, 모든 트래픽이 새로운 jwt로 적용되고 난 이후에 이전 규칙을 제거해야합니다. 단, 새로운 jwt는 이전의 jwt와 다른 위치를 사용해야합니다.</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/infra/'>Infra</a>, <a href='/categories/istio/'>Istio</a>, <a href='/categories/security/'>Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/servicemesh/" class="post-tag no-text-decoration" >ServiceMesh</a> <a href="/tags/istio/" class="post-tag no-text-decoration" >Istio</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Istio+%EC%97%90%EC%84%9C%EC%9D%98+authentication+-+%EB%82%98%EB%AC%B4%EA%B3%84%EB%8B%A8+%EB%B8%94%EB%A1%9C%EA%B7%B8&url=https%3A%2F%2Fwoodsection.github.io%2Fposts%2Fistio-security-authentication%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Istio+%EC%97%90%EC%84%9C%EC%9D%98+authentication+-+%EB%82%98%EB%AC%B4%EA%B3%84%EB%8B%A8+%EB%B8%94%EB%A1%9C%EA%B7%B8&u=https%3A%2F%2Fwoodsection.github.io%2Fposts%2Fistio-security-authentication%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwoodsection.github.io%2Fposts%2Fistio-security-authentication%2F&text=Istio+%EC%97%90%EC%84%9C%EC%9D%98+authentication+-+%EB%82%98%EB%AC%B4%EA%B3%84%EB%8B%A8+%EB%B8%94%EB%A1%9C%EA%B7%B8" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/curl/">curl 커맨드의 --user 옵션</a><li><a href="/posts/maven/">Maven이란 ?</a><li><a href="/posts/istio-security/">Istio의 Security</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/istio/">Istio</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/servicemesh/">ServiceMesh</a> <a class="post-tag" href="/tags/command/">Command</a> <a class="post-tag" href="/tags/linux/">Linux</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/istio-security/"><div class="card-body"> <em class="small" data-ts="1658757900" data-df="ll" > Jul 25, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Istio의 Security</h3><div class="text-muted small"><p> 보안(Security) istio를 사용했을 때의 보안적인 특징 애플리케이션과 인프라 코드의 수정없이 기본적으로 보안이 적용됨 기존 보안 시스템과 통합하여 보안 적용 신뢰할 수 없는 네트워크에도 보안을 적용할 수 있음 아키텍쳐 CA(Certificate Authority) key와 인증 관리 설정 API 서버에서 프록...</p></div></div></a></div><div class="card"> <a href="/posts/maven-local/"><div class="card-body"> <em class="small" data-ts="1663488960" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Maven Local</h3><div class="text-muted small"><p> 개요 spring 으로 만들어진 레거시 프로젝트를 살펴보다가, 패키지를 가져올때 maven repo가 아닌 로컬에서 빌드해둔 jar 파일을 import 해오는 구문을 발견했습니다. 살펴보던 프로젝트는 msa에서 하나의 서비스 부분이였는데, 구글 protobuf로 만들어둔 dto 클래스 모음 프로젝트를 로컬에 jar로 빌드하고 해당 jar을 각 ...</p></div></div></a></div><div class="card"> <a href="/posts/curl/"><div class="card-body"> <em class="small" data-ts="1663485360" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>curl 커맨드의 --user 옵션</h3><div class="text-muted small"><p> Curl 커맨드 curl 명령어는 다음과 같이 사용되며 기본적으로 REST 서비스로 api 요청 테스트등을 위해 사용됩니다. 1 curl [options] &amp;lt;url&amp;gt; –user 옵션 api test를 위해서 curl 명령어 README를 작성하다가 찾게된 내용중에 생소한 --user 옵션이 있어 해당내용에 대해 간단히 기록하려고합니...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/istio-security/" class="btn btn-outline-primary" prompt="Older"><p>Istio의 Security</p></a> <a href="/posts/curl/" class="btn btn-outline-primary" prompt="Newer"><p>curl 커맨드의 --user 옵션</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://www.rocketpunch.com/@wdsection">woodsection</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/istio/">Istio</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/servicemesh/">ServiceMesh</a> <a class="post-tag" href="/tags/command/">Command</a> <a class="post-tag" href="/tags/linux/">Linux</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
